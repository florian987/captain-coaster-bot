#image: $CI_REGISTRY_IMAGE:ci
image: registry.gitlab.com/jffz/discordbot:ci

variables:
  PIPENV_CACHE_DIR: "$CI_PROJECT_DIR/pipenv-cache"

cache:
  paths:
    - "$CI_PROJECT_DIR/pipenv-cache"
    - "$CI_PROJECT_DIR/.venv"

stages:
  - test
  - build

test:
  stage: test

  image: docker:stable

  services:
    - docker:dind

#  before_script:
#    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY

  script:
    - |
      apk add --no-cache \
        docker \
        python3-dev \
        build-base \
        jpeg-dev \
        libffi-dev \
        zlib-dev
    - pip3 install pipenv
    - pipenv install --dev --deploy
    - pipenv run lint --exit-zero 

ðŸ‘· build:
  stage: ðŸ‘· build
  services:
    - docker:stable

  stage: build
  script:
    - bash scripts/deploy.sh
